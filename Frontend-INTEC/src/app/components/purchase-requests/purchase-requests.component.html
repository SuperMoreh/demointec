<div class="content-container">
  <!-- Header de la página -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Solicitudes de Compras</h1>
    </div>
    <a (click)="setCreateMode()" class="btn-primary" data-bs-toggle="modal" data-bs-target="#agregarSolicitudModal">
      <i class="bi bi-plus-circle"></i>
      Nueva Solicitud
    </a>
  </div>

  <!-- Filtros y búsqueda -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="filter-group">
        <label for="search">Buscar</label>
        <input type="text" id="search" class="filter-input" placeholder="Folio, proyecto o solicitante..." [(ngModel)]="searchTerm" (input)="applyFilters()">
      </div>
      <div class="filter-group">
        <select id="status" class="filter-input" [(ngModel)]="selectedStatus" (change)="applyFilters()">
          <option value="">Todos los estados</option>
          <option value="true">Activo</option>
          <option value="false">Inactivo</option>
        </select>
      </div>
      <button class="btn-consult" (click)="consultRequests()" [disabled]="isLoading">
        <i class="bi bi-search"></i>
      </button>
      <button class="btn-filter" (click)="clearFilters()">
        <i class="bi bi-list-ul"></i>
      </button>
      <button class="btn-sync" (click)="syncRequests()" title="Sincronizar solicitudes" [disabled]="isLoading">
        <i class="bi bi-arrow-repeat"></i>
      </button>
    </div>
  </div>

  <!-- Tabla de solicitudes -->
  <div class="table-container" *ngIf="hasConsulted && !isLoading && filteredRequests.length > 0">
    <div class="table-header">
      <div class="table-info">
        Mostrando {{ requests.length }} de {{ allRequests.length }} solicitudes
        <span *ngIf="hasActiveFilters()" class="text-muted">(filtradas)</span>
      </div>
      <div class="table-actions">
        <button class="btn-filter1" (click)="exportRequests()">
          <i class="bi bi-download"></i>
          Exportar
        </button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="users-table">
        <thead>
          <tr>
            <th>Folio</th>
            <th>Proyecto</th>
            <th>Solicitante</th>
            <th>Fecha</th>
            <th>Proceso</th>
            <th>Oficial</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let request of requests">
            <td>{{ request.folio_request }}</td>
            <td>{{ request.project }}</td>
            <td>{{ request.requester }}</td>
            <td>{{ request.date | date:'dd/MM/yyyy' }}</td>
            <td>{{ request.status_header }}</td>
            <td>{{ request.official }}</td>
            <td>
              <span class="status-badge" [ngClass]="request.status ? 'status-active' : 'status-inactive'">
                {{ request.status ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-action btn-edit" (click)="handleEditClick(request)" title="Editar">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn-action btn-delete" (click)="deleteRequest(request)" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- Paginación -->
    <div class="pagination-container" *ngIf="totalPages > 1">
      <div class="pagination">
        <button [disabled]="currentPage === 1" (click)="setPage(currentPage - 1)">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button *ngFor="let page of pages" [class.active]="page === currentPage" (click)="setPage(page)">
          {{ page }}
        </button>
        <button [disabled]="currentPage === totalPages" (click)="setPage(currentPage + 1)">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
  <div class="table-container placeholder-container" *ngIf="hasConsulted && !isLoading && filteredRequests.length === 0">
    <div class="table-placeholder">
      <i class="bi bi-inbox"></i>
      No se encontraron solicitudes con los filtros aplicados.
    </div>
  </div>
  <div class="table-container placeholder-container" *ngIf="hasConsulted && isLoading">
    <div class="table-placeholder">
      <i class="bi bi-arrow-repeat loading-icon"></i>
      Cargando solicitudes...
    </div>
  </div>
  <div class="consult-placeholder" *ngIf="!hasConsulted">
    <i class="bi bi-info-circle"></i>
    Consulte para ver la información de solicitudes de compra.
  </div>
</div>

<!-- Modal para Agregar Solicitud -->
<div class="modal fade" id="agregarSolicitudModal" tabindex="-1" aria-labelledby="agregarSolicitudModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="agregarSolicitudModalLabel">
          <i class="bi bi-plus-circle me-2"></i>Nueva Solicitud de Compra
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="requestForm" (ngSubmit)="createRequest()">
          <!-- Folio destacado -->
          <div class="text-center mb-4 p-3 bg-light rounded">
            <label class="form-label fw-bold text-muted mb-1">NO. SOLICITUD:</label>
            <div class="fw-bold fs-2 text-danger">{{ requestForm.value.folio_request || '---' }}</div>
          </div>

          <!-- Datos principales -->
          <div class="row g-3 mb-4">
                <div class="col-md-6">
              <label class="form-label fw-semibold">Proyecto *</label>
              <input formControlName="project" type="text" class="form-control form-control-sm" placeholder="Nombre del proyecto">
                  </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Solicitante *</label>
              <input formControlName="requester" type="text" class="form-control form-control-sm" placeholder="Nombre del solicitante">
                </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Oficial *</label>
              <input formControlName="official" type="text" class="form-control form-control-sm" placeholder="Nombre del oficial">
                  </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Localidad *</label>
              <input formControlName="locality" type="text" class="form-control form-control-sm" placeholder="Localidad">
                </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Fecha *</label>
              <input formControlName="date" type="date" class="form-control form-control-sm" [value]="getCurrentDate()">
              </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Hora *</label>
              <input formControlName="hour" type="time" class="form-control form-control-sm" [value]="getCurrentTime()">
                </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Tipo de Ubicación *</label>
              <input formControlName="locationType" type="text" class="form-control form-control-sm" placeholder="Tipo de ubicación">
              </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Trabajo *</label>
              <input formControlName="work" type="text" class="form-control form-control-sm" placeholder="Descripción del trabajo">
            </div>
          </div>

          <!-- Gestión de Artículos -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h6 class="fw-bold mb-0">
                <i class="bi bi-box me-2"></i>Artículos
              </h6>
            </div>
            <div class="card-body">
              <div [formGroup]="detailsForm">
                <div class="row g-2">
                  <div class="col-md-4">
                    <label class="form-label fw-semibold small">Artículo *</label>
                    <select formControlName="name" class="form-control form-control-sm" (change)="onArticleChange()">
                      <option value="">Seleccionar artículo...</option>
                      <optgroup label="MATERIALES">
                        <option *ngFor="let material of materials" [value]="getItemValue(material)">
                          {{ material.name_material }}
                        </option>
                      </optgroup>
                      <optgroup label="HERRAMIENTAS">
                        <option *ngFor="let tool of tools" [value]="getItemValue(tool)">
                          {{ tool.name_tool }}
                        </option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold small">Cantidad *</label>
                    <input formControlName="amount" type="number" class="form-control form-control-sm" placeholder="0">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold small">Costo Unit. *</label>
                    <input formControlName="unit_cost" type="number" step="0.01" class="form-control form-control-sm" placeholder="0.00">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold small">Unidad *</label>
                    <input formControlName="unit" type="text" class="form-control form-control-sm" placeholder="PZA, KG, etc.">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold small">Acciones</label>
                    <div class="d-flex gap-1">
                        <button type="button" class="btn btn-primary btn-sm" (click)="isDetailEditMode ? updateDetail() : addDetail()" [disabled]="detailsForm.invalid">
                        <i class="bi" [ngClass]="isDetailEditMode ? 'bi-check' : 'bi-plus'"></i>
                        </button>
                      <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelDetailEditForm()" *ngIf="isDetailEditMode">
                        <i class="bi bi-x"></i>
                        </button>
                    </div>
                  </div>
                </div>
                
                <!-- Campos específicos por tipo de artículo -->
                <div class="row g-2 mt-2" *ngIf="selectedArticleType">
                  <!-- Campos para Materiales -->
                  <ng-container *ngIf="selectedArticleType === 'M'">
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">Código</label>
                      <input formControlName="code" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">C1</label>
                      <input formControlName="c1" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">C2</label>
                      <input formControlName="c2" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">Partida</label>
                      <input formControlName="category" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">Subpartida</label>
                      <input formControlName="subcategory" type="text" class="form-control form-control-sm" readonly>
                    </div>
                  </ng-container>
                  
                  <!-- Campos para Herramientas -->
                  <ng-container *ngIf="selectedArticleType === 'H'">
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">Código</label>
                      <input formControlName="code" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-9">
                      <label class="form-label fw-semibold small">Descripción</label>
                      <textarea formControlName="description" class="form-control form-control-sm" rows="2" readonly></textarea>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabla de Artículos -->
          <div class="card mb-4" *ngIf="requestDetails.length > 0">
            <div class="card-header bg-light">
              <h6 class="fw-bold mb-0">
                <i class="bi bi-list-ul me-2"></i>Artículos Agregados ({{ requestDetails.length }})
              </h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center" style="width: 60px;">CANT.</th>
                      <th>PRODUCTO</th>
                      <th class="text-center" style="width: 80px;">UNIDAD</th>
                      <th class="text-end" style="width: 100px;">PRECIO</th>
                      <th class="text-end" style="width: 100px;">SUBTOTAL</th>
                      <th class="text-center" style="width: 80px;">ACCIONES</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let detail of requestDetails">
                      <td class="text-center fw-bold">{{ detail.amount }}</td>
                      <td>{{ detail.name }}</td>
                      <td class="text-center">{{ detail.unit }}</td>
                      <td class="text-end">${{ detail.unit_cost | number:'1.2-2' }}</td>
                      <td class="text-end fw-bold">${{ detail.amount * detail.unit_cost | number:'1.2-2' }}</td>
                      <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary" (click)="editDetail(detail)" title="Editar">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeDetail(detail)" title="Eliminar">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Observaciones</label>
            <textarea formControlName="notes" class="form-control form-control-sm" rows="2" placeholder="Observaciones adicionales"></textarea>
          </div>

          <!-- Resumen y Acciones -->
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card border-primary">
                <div class="card-body p-3">
                  <h6 class="card-title fw-bold text-primary mb-3">
                    <i class="bi bi-calculator me-2"></i>Resumen Financiero
                  </h6>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="fw-semibold">Subtotal:</span>
                    <span class="fw-bold">${{ subtotal | number:'1.2-2' }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="fw-semibold">
                      <input type="checkbox" [ngModel]="ivaEnabled" [ngModelOptions]="{standalone: true}" (change)="toggleIva()" class="me-2">
                      IVA (16%):
                    </span>
                    <span class="fw-bold">${{ iva | number:'1.2-2' }}</span>
                  </div>
                  <hr class="my-2">
                  <div class="d-flex justify-content-between">
                    <span class="fw-bold fs-5">TOTAL:</span>
                    <span class="fw-bold fs-5 text-primary">${{ total | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-success">
                <div class="card-body p-3 text-center">
                  <h6 class="card-title fw-bold text-success mb-3">
                    <i class="bi bi-box me-2"></i>Artículos: {{ requestDetails.length }}
                  </h6>
                  <button type="button" class="btn btn-success btn-lg w-100" (click)="finishRequest()" [disabled]="requestDetails.length === 0">
                    <i class="bi bi-check-circle me-2"></i>Guardar Solicitud
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Editar Solicitud -->
<div class="modal fade" id="editarSolicitudModal" tabindex="-1" aria-labelledby="editarSolicitudModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="editarSolicitudModalLabel">
          <i class="bi bi-pencil-square me-2"></i>Modificar Solicitud de Compra
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" *ngIf="selectedRequest">
        <form [formGroup]="requestForm" (ngSubmit)="updateRequest()">
          <!-- Folio destacado -->
          <div class="text-center mb-4 p-3 bg-light rounded">
            <label class="form-label fw-bold text-muted mb-1">NO. SOLICITUD:</label>
            <div class="fw-bold fs-2 text-danger">{{ requestForm.value.folio_request || '---' }}</div>
          </div>

          <!-- Datos principales -->
          <div class="row g-3 mb-4">
                <div class="col-md-6">
              <label class="form-label fw-semibold">Proyecto *</label>
              <input formControlName="project" type="text" class="form-control form-control-sm" placeholder="Nombre del proyecto">
                  </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Solicitante *</label>
              <input formControlName="requester" type="text" class="form-control form-control-sm" placeholder="Nombre del solicitante">
                </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Oficial *</label>
              <input formControlName="official" type="text" class="form-control form-control-sm" placeholder="Nombre del oficial">
              </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Localidad *</label>
              <input formControlName="locality" type="text" class="form-control form-control-sm" placeholder="Localidad">
                </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Fecha *</label>
              <input formControlName="date" type="date" class="form-control form-control-sm">
              </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Hora *</label>
              <input formControlName="hour" type="time" class="form-control form-control-sm">
                </div>
                <div class="col-md-6">
              <label class="form-label fw-semibold">Tipo de Ubicación *</label>
              <input formControlName="locationType" type="text" class="form-control form-control-sm" placeholder="Tipo de ubicación">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Trabajo *</label>
              <input formControlName="work" type="text" class="form-control form-control-sm" placeholder="Descripción del trabajo">
            </div>
          </div>

          <!-- Estados de la solicitud -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Estatus del Proceso *</label>
              <input formControlName="status_header" type="text" class="form-control form-control-sm" placeholder="Descripción del trabajo">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Estado de la Solicitud *</label>
              <div class="d-flex align-items-center">
                <div class="form-check form-switch me-3">
                  <input class="form-check-input" type="checkbox" formControlName="status" id="statusSwitch">
                  <label class="form-check-label" for="statusSwitch">
                    <span [ngClass]="requestForm.get('status')?.value ? 'text-success fw-bold' : 'text-danger fw-bold'">
                      {{ requestForm.get('status')?.value ? 'Activo' : 'Inactivo' }}
                    </span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Gestión de Artículos -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h6 class="fw-bold mb-0">
                <i class="bi bi-box me-2"></i>Artículos
              </h6>
            </div>
            <div class="card-body">
              <div [formGroup]="detailsForm">
                <div class="row g-2">
                  <div class="col-md-4">
                    <label class="form-label fw-semibold small">Artículo *</label>
                    <select formControlName="name" class="form-control form-control-sm" (change)="onArticleChange()">
                      <option value="">Seleccionar artículo...</option>
                      <optgroup label="MATERIALES">
                        <option *ngFor="let material of materials" [value]="getItemValue(material)">
                          {{ material.name_material }}
                        </option>
                      </optgroup>
                      <optgroup label="HERRAMIENTAS">
                        <option *ngFor="let tool of tools" [value]="getItemValue(tool)">
                          {{ tool.name_tool }}
                        </option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold small">Cantidad *</label>
                    <input formControlName="amount" type="number" class="form-control form-control-sm" placeholder="0">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold small">Costo Unit. *</label>
                    <input formControlName="unit_cost" type="number" step="0.01" class="form-control form-control-sm" placeholder="0.00">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold small">Unidad *</label>
                    <input formControlName="unit" type="text" class="form-control form-control-sm" placeholder="PZA, KG, etc.">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold small">Acciones</label>
                    <div class="d-flex gap-1">
                        <button type="button" class="btn btn-primary btn-sm" (click)="isDetailEditMode ? updateDetail() : addDetail()" [disabled]="detailsForm.invalid">
                        <i class="bi" [ngClass]="isDetailEditMode ? 'bi-check' : 'bi-plus'"></i>
                        </button>
                      <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelDetailEditForm()" *ngIf="isDetailEditMode">
                        <i class="bi bi-x"></i>
                        </button>
                    </div>
                  </div>
                </div>
                
                <!-- Campos específicos por tipo de artículo -->
                <div class="row g-2 mt-2" *ngIf="selectedArticleType">
                  <!-- Campos para Materiales -->
                  <ng-container *ngIf="selectedArticleType === 'M'">
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">Código</label>
                      <input formControlName="code" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">C1</label>
                      <input formControlName="c1" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">C2</label>
                      <input formControlName="c2" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">Partida</label>
                      <input formControlName="category" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">Subpartida</label>
                      <input formControlName="subcategory" type="text" class="form-control form-control-sm" readonly>
                    </div>
                  </ng-container>
                  
                  <!-- Campos para Herramientas -->
                  <ng-container *ngIf="selectedArticleType === 'H'">
                    <div class="col-md-3">
                      <label class="form-label fw-semibold small">Código</label>
                      <input formControlName="code" type="text" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-9">
                      <label class="form-label fw-semibold small">Descripción</label>
                      <textarea formControlName="description" class="form-control form-control-sm" rows="2" readonly></textarea>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabla de Artículos -->
          <div class="card mb-4" *ngIf="requestDetails.length > 0">
            <div class="card-header bg-light">
              <h6 class="fw-bold mb-0">
                <i class="bi bi-list-ul me-2"></i>Artículos Agregados ({{ requestDetails.length }})
              </h6>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center" style="width: 60px;">CANT.</th>
                      <th>PRODUCTO</th>
                      <th class="text-center" style="width: 80px;">UNIDAD</th>
                      <th class="text-end" style="width: 100px;">PRECIO</th>
                      <th class="text-end" style="width: 100px;">SUBTOTAL</th>
                      <th class="text-center" style="width: 80px;">ACCIONES</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let detail of requestDetails">
                      <td class="text-center fw-bold">{{ detail.amount }}</td>
                      <td>{{ detail.name }}</td>
                      <td class="text-center">{{ detail.unit }}</td>
                      <td class="text-end">${{ detail.unit_cost | number:'1.2-2' }}</td>
                      <td class="text-end fw-bold">${{ detail.amount * detail.unit_cost | number:'1.2-2' }}</td>
                      <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary" (click)="editDetail(detail)" title="Editar">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeDetail(detail)" title="Eliminar">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="mb-4">
            <label class="form-label fw-semibold">Observaciones</label>
            <textarea formControlName="notes" class="form-control form-control-sm" rows="2" placeholder="Observaciones adicionales"></textarea>
          </div>

          <!-- Resumen y Acciones -->
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card border-warning">
                <div class="card-body p-3">
                  <h6 class="card-title fw-bold text-warning mb-3">
                    <i class="bi bi-calculator me-2"></i>Resumen Financiero
                  </h6>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="fw-semibold">Subtotal:</span>
                    <span class="fw-bold">${{ subtotal | number:'1.2-2' }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="fw-semibold">
                      <input type="checkbox" [ngModel]="ivaEnabled" [ngModelOptions]="{standalone: true}" (change)="toggleIva()" class="me-2">
                      IVA (16%):
                    </span>
                    <span class="fw-bold">${{ iva | number:'1.2-2' }}</span>
                  </div>
                  <hr class="my-2">
                  <div class="d-flex justify-content-between">
                    <span class="fw-bold fs-5">TOTAL:</span>
                    <span class="fw-bold fs-5 text-warning">${{ total | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-warning">
                <div class="card-body p-3 text-center">
                  <h6 class="card-title fw-bold text-warning mb-3">
                    <i class="bi bi-box me-2"></i>Artículos: {{ requestDetails.length }}
                  </h6>
                  <button type="button" class="btn btn-warning btn-lg w-100" (click)="saveRequestChanges()">
                    <i class="bi bi-check-circle me-2"></i>Guardar Cambios
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div> 

<!-- Modal pequeño para confirmar edición de artículo -->
<div class="modal fade" [class.show]="showEditArticleModal" [style.display]="showEditArticleModal ? 'block' : 'none'" tabindex="-1" *ngIf="showEditArticleModal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h6 class="modal-title">
          <i class="bi bi-question-circle me-2"></i>Editar Artículo
        </h6>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <i class="bi bi-pencil-square display-4 text-info"></i>
        </div>
        <p class="mb-3">¿Deseas editar el artículo seleccionado?</p>
        <div class="fw-bold text-primary" *ngIf="editingRequestDetail">
          {{ editingRequestDetail.name }}
        </div>
        <small class="text-muted d-block mt-2" *ngIf="editingRequestDetail">
          Cantidad: {{ editingRequestDetail.amount }} | Costo: ${{ editingRequestDetail.unit_cost }}
        </small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cancelEditDetail()">
          <i class="bi bi-x-circle me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-info btn-sm" (click)="confirmEditDetail()">
          <i class="bi bi-pencil me-1"></i>Editar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay del modal -->
<div class="modal-backdrop fade" [class.show]="showEditArticleModal" *ngIf="showEditArticleModal"></div> 